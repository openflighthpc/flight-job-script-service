# Intentionally has a different name to the directory
name: tophat-demo
script_template: tophat.sh
version: 0
synopsis: Tophat v2.1.0
description: |
  Tophat example script.

generation_questions:
  - id: stdout_file
    text: "Set an output file for STDOUT"
    description: >
      Specify a path to a file to contain the output from the standard output
      stream of your job script.
    default: job-%j.output
    format:
      type: text

  - id: merge_stderr_with_stdout
    text: "Merge STDERR into STDOUT"
    description: >
      Enable this option to merge the standard error output stream into
      standard output - this is usually the best option unless you have a
      specific need to keep the output streams separated.
    default: 'yes'
    format:
      type: select
      options:
        - text: 'Yes'
          value: 'yes'
        - text: 'No'
          value: 'no'

  - id: stderr_file
    text: "Set an output file for STDERR"
    description: >
      Specify a path to a file to contain the output from the standard error
      stream of your job script.
    default: job-%j.error
    format:
      type: text
    ask_when:
      value: question.merge_stderr_with_stdout.answer
      eq: 'no'

  - id: workload
    text: "Workload"
    description: >
      Enter your tophat workload below.  An example is provided for you.
    default: |
      #
      # For full TopHat usage information see:
      #   http://tophat.cbcb.umd.edu/manual.html
      # Test data may be downloaded from:
      #   http://tophat.cbcb.umd.edu/downloads/test_data.tar.gz

      # Checking for example data
      if [ -d "_GRIDWARE_/data/_DATADIR_" ]; then
        DATA_DIR="_GRIDWARE_/data/_DATADIR_"
      elif [ -d "$HOME/gridware/data/_DATADIR_" ]; then
        DATA_DIR="$HOME/gridware/data/_DATADIR_"
      else
        echo "Prepare your data first with 'alces template prepare _TEMPLATE_'."
        exit 1
      fi

      # Loading Tophat module
      module load apps/tophat/2.1.0

      # Setting input directory
      INPUT_DIR="${HOME}/tophat/input"

      # Output directory (default is 'tophat_out')
      OUTPUT_DIR="${HOME}/tophat/output.${JOB_ID-${PORTAL_TASK_ID-$$}}"

      # Creating working directories
      mkdir -p $INPUT_DIR
      mkdir -p $OUTPUT_DIR

      # Copying example data to working directory
      cp -vr "${DATA_DIR}/." "${INPUT_DIR}/"

      # Base name of genome index to be searched (i.e. up to first period)
      GENOME_INDEX_BASE="${INPUT_DIR}/test_ref"

      # Comma-separated list of FASTQ/FASTA files of reads ('left')
      READS_1="${INPUT_DIR}/reads_1.fq"

      # Optional: comma-sep list of FASTQ/FASTA files of reads ('right')
      READS_2="${INPUT_DIR}/reads_2.fq"

      # Additional command-line options (tophat -h for a list)
      TOPHAT_OPTIONS="-r 20"

      # Execute Tophat
      tophat -o $OUTPUT_DIR $TOPHAT_OPTIONS $GENOME_INDEX_BASE $READS_1 $READS_2
    format:
      type: multiline_text
